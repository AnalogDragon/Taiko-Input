# USB-MCU工程

[EN](./README_EN.md)  

[主页](../)  

MCU：CH552，IDE：KEIL 4  
单片机官网：[沁恒CH552](https://www.wch.cn/products/CH552.html)  

</br>

## 软件流程
软件按照如下运行  

```
采样输入 -> 输出频率限制 -> 分配输出 -> 键值映射 -> USB
```

</br>

### 输出频率限制
对输出进行频率限制主要是因为接收数据的硬件或程序，收到了超过其处理能力的数据时，会产生丢包的现象。  
经过多次测试，虹的软件输入限制为所有通道输入频率最高为60Hz，相同颜色的信号最高为30Hz。  
n******o switch限制输入信号的时间为20ms（按下与抬起都为20ms左右，小于这个值可能会导致输入与上一个输入粘连）  
其他电脑上运行的自治软件，通常无这方便的限制，但是在选择页面会有10ms左右的滤波。  

</br>

### 分配输出
分配输出主要用于使输入频率能达到这台设备的上限，不同的设备采取的方案不相同。
- 虹：由于有着所有通道最高60Hz，同颜色最高30Hz的频率限制，所以在这里会缓存每个通道3次输入，并将多出来的“咚”分配到另一个鼓面，使输入带宽占满。
- ns：ns的键位通常为左右手各4个按键，在输入频率高的时候，需要将其分配到不同的按键上（比如说Y与B都为“咚”，则输入频率高的时候的时候，Y与B交替键入，频率低的时候只键入B）

</br>

### 键值映射
- 双鼓硬件，鼓的输入映射为键盘输入的DFJK ZXCV，服务按键映射为键盘输入的12345678。
- 单鼓硬件，分为ns和键盘输入，其中ns输入键位见下图，键盘输入可以通过按键设置为DFJK或ZXCV，默认为DFJK。

![标签](./img/tag.png "标签")  

单鼓硬件的标签

</br>

## 程序的修改

</br>

### 双鼓软件

- 关闭分配输出功能，则需修改将位于`CompatibilityHID.C`内的宏`WITHOUT_OUTPUT_ASSIGN`取消注释。
- 修改输出频率限制相关的参数，修改位于`CompatibilityHID.C`内的宏`EXCHANGE_DATA`。
- 修改键值，则修改位于`CompatibilityHID.C`内的`Enp2BlukIn`函数的数组。

</br>

### 单鼓软件
单鼓软件内，集成了三种模式，分别是ns模式（盗用了HORI的PID/VID），适配虹的键盘模式（锁60Hz输入），适配其他太鼓软件的键盘模式（解锁限制并关闭分配输出）三种。  

- 修改`CompatibilityHID.C`内的宏`MODE_STARTUP`，则可以修改启动时候默认的模式。  
- 启动前1s内按如下按键，则可以切换模式
```
...
if(!KEY1)start_up_mode = MODE_NS_GP;
if(!KEY2)start_up_mode = MODE_KEYBOARD;
if(!KEY3)start_up_mode = MODE_KB_LMT;
if(!KEY4)start_up_mode = MODE_STARTUP;
...
```
- 运行时，按住1~4所有的按键，则可以进行复位，以重新切换模式。

